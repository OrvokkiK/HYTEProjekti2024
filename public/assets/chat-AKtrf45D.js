import"./style-Bvx2onkj.js";import{f as h}from"./fetch-dnjvk_SN.js";import{s as _}from"./toast-B-6j1RQv.js";document.addEventListener("DOMContentLoaded",function(){const l=document.querySelector(".menu-toggle"),s=document.querySelector(".menu");l.addEventListener("click",function(){s.classList.toggle("show")})});document.addEventListener("DOMContentLoaded",function(){const l=localStorage.getItem("token"),s=localStorage.getItem("user_id"),y=document.getElementById("send-button"),u=document.getElementById("conversation-list"),m=document.getElementById("messages-container"),g=document.querySelector(".message-write");u.addEventListener("click",n=>{const e=n.target.closest("li");e&&e.dataset.conversationId&&e.dataset.recipientId&&(r=e.dataset.conversationId,a=e.dataset.recipientId,console.log(`Current recipient ID: ${a}`),console.log(r),p(r))}),y.addEventListener("click",L);let a=null,r=null;const I=`https://hyte24.northeurope.cloudapp.azure.com/api/messages/user/${s}`,v={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`}};h(I,v).then(n=>{Array.isArray(n)&&n.length>0?(g.style.display="block",n.forEach(e=>{const t=document.createElement("li");t.textContent=`Keskustelu ${e.conversation_id}`,t.dataset.conversationId=e.conversation_id,t.dataset.recipientId=e.recipient_id,u.appendChild(t)})):(m.innerHTML='<div class="no-messages">Sinulle ei ole uusia viestejä.</div>',g.style.display="none")}).catch(n=>{console.error("Keskusteluiden haku epäonnistui:",n),m.innerHTML='<div class="no-messages">Virhe haettaessa keskusteluja.</div>',g.style.display="none"}),u.addEventListener("click",n=>{const e=n.target.closest("li");if(e&&e.dataset.conversationId){r=e.dataset.conversationId,a=e.dataset.recipientId,a||console.error("No recipient ID found for selected conversation");const t=document.getElementById("messages-container");t.innerHTML="",p(r)}});function p(n){const e=`https://hyte24.northeurope.cloudapp.azure.com/api/messages/conversation/${n}`;h(e,v).then(t=>{if(Array.isArray(t)&&t.length>0){const o=t.find(i=>i.sender_id!==s);o?(a=o.sender_id,console.log("tämä on vastaanottaja",a),k(a).then(i=>{E(i),f(t,s)}).catch(i=>{console.error("Failed to fetch user name:",i)})):f(t,s)}else m.innerHTML='<div class="no-messages">Ei viestejä tässä keskustelussa.</div>'}).catch(t=>{console.error(`Viestien haku epäonnistui keskustelulle ${n}:`,t)})}async function k(n){const e=`https://hyte24.northeurope.cloudapp.azure.com/api/users/${n}`,t=await fetch(e,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`}});if(!t.ok)throw new Error("Failed to fetch user");return(await t.json())[0].username}function E(n){const e=document.getElementById("conversation-header");e.textContent=`Keskustelu sairaanhoitajan ${n} kanssa`}function f(n,e){const t=document.getElementById("messages-container");t.innerHTML="",n.forEach(o=>{const d=new Date(o.message_sent_at).toLocaleString("fi-FI",{timeZone:"Europe/Helsinki"}),c=document.createElement("div");parseInt(o.sender_id)===parseInt(e)?c.className="message client":c.className="message professional",c.innerHTML=`
      <div class="date">${d}</div>
        <div class="message-text">${o.message_content}</div>
      `,t.appendChild(c)}),n.length===0&&(t.innerHTML='<div class="no-messages">Ei saapuneita viestejä</div>')}function L(){const n=localStorage.getItem("token"),e=localStorage.getItem("user_id"),t=document.getElementById("message-input"),o=t.value,i=new Date().toISOString().slice(0,19).replace("T"," "),d={conversation_id:r,recipient_id:a,message_content:o,message_sent_at:i,sender_id:e};console.log(d);const c="https://hyte24.northeurope.cloudapp.azure.com/api/messages/",S={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(d)};h(c,S),t.value="",console.log("Lähetetty viesti:",o),p(r)}});document.addEventListener("DOMContentLoaded",function(){document.querySelector(".logout a").addEventListener("click",function(s){s.preventDefault(),localStorage.removeItem("analysisModalShown"),localStorage.removeItem("user_id"),localStorage.removeItem("token"),_("Kirjaudutaan ulos."),setTimeout(()=>{window.location.href="index.html"},2e3)})});
